//- extends ../layouts/default

//- block content
//-   .container.mt-5
//-     h1.text-center.mb-5 Đề thi Reading TOEIC

//-     // Hiển thị thông báo lỗi hoặc thông tin
//-     if error
//-       .alert.alert-danger.text-center(role='alert')
//-         i.bi.bi-exclamation-triangle.me-2
//-         | #{error}
//-     else if !examPart
//-       .alert.alert-info.text-center(role='alert')
//-         i.bi.bi-info-circle.me-2
//-         | Không có đề thi Reading nào được tìm thấy hoặc đề thi chưa được public.
//-     else
//-       // Thông tin đề thi
//-       .card.mb-5.shadow-sm
//-         .card-header.bg-primary.text-white.d-flex.justify-content-between.align-items-center
//-           h2.mb-0
//-             | Đề #{examPart._id} - Part #{examPart.part ? examPart.part.join(', ') : 'N/A'}
//-           span.badge.bg-light.text-dark
//-             | Độ khó: #{difficultyMap[examPart.difficulty] || 'Chưa xác định'}

//-         .card-body
//-           .d-flex.justify-content-between.align-items-center.mb-4
//-             p.mb-0.fw-bold
//-               | Thời gian còn lại: 
//-               span#timer.text-danger.fw-bold.ms-2 30:00
//-             p.mb-0.fw-bold
//-               | Đã trả lời: 
//-               span#answeredCount.text-primary.fw-bold.ms-2 0
//-             a.btn.btn-outline-secondary.btn-sm(href='/toeic/reading') Quay lại danh sách đề

//-       // Cảnh báo nếu thiếu Part
//-       if !questionsByPart['Part 5'] && examPart.part.includes(5)
//-         .alert.alert-warning.text-center(role='alert')
//-           i.bi.bi-exclamation-circle.me-2
//-           | Không có câu hỏi nào cho Part 5.
//-       if !questionsByPart['Part 6'] && examPart.part.includes(6)
//-         .alert.alert-warning.text-center(role='alert')
//-           i.bi.bi-exclamation-circle.me-2
//-           | Không có câu hỏi nào cho Part 6.
//-       if !questionsByPart['Part 7'] && examPart.part.includes(7)
//-         .alert.alert-warning.text-center(role='alert')
//-           i.bi.bi-exclamation-circle.me-2
//-           | Không có câu hỏi nào cho Part 7.

//-       // Form làm bài
//-       form#examForm(action=`/toeic/reading/${examPart._id}/submit`, method='POST')
//-         input(type='hidden', name='examPartId', value=examPart._id)

//-         // Hiển thị từng Part
//-         each partKey in ['Part 5', 'Part 6', 'Part 7']
//-           if questionsByPart[partKey]
//-             .card.mt-4.shadow-sm
//-               .card-header.bg-light.fw-bold.text-dark #{partKey}
//-               .card-body
//-                 - let currentPassage = null
//-                 each question in questionsByPart[partKey]
//-                   if question.type === 'passage'
//-                     - currentPassage = question
//-                     .mb-4
//-                       p.mb-2.fw-bold Câu #{question.displayNumber}:
//-                       pre.bg-light.p-3.rounded.border(style='white-space: pre-wrap; font-size: 1rem;') #{question.passage || 'Không có đoạn văn'}
//-                       if question.Img
//-                         img.img-fluid.rounded.mb-3(src=question.Img, alt='Passage Image', style='max-height: 300px; max-width: 100%;')
//-                   else
//-                     if (partKey === 'Part 6' || partKey === 'Part 7') && currentPassage && currentPassage.questionId.toString() === question.questionId.toString()
//-                       .question.border.p-4.mb-4.rounded.bg-white.shadow-sm
//-                         h5.mb-3.text-dark #{question.displayNumber}
//-                         p.mb-3.fw-bold.text-muted #{question.questionText || 'Không có nội dung câu hỏi'}

//-                         if question.options && Array.isArray(question.options) && question.options.length === 4
//-                           each option, optIndex in question.options
//-                             .form-check.mb-2
//-                               - const inputId = `${question.questionId}-${question.blankIndex || question.subQuestionIndex || 0}-${optIndex}`
//-                               - const inputName = `answers[${question.questionId}-${question.blankIndex || question.subQuestionIndex || 0}]`
//-                               input.form-check-input(
//-                                 type='radio',
//-                                 id=inputId,
//-                                 name=inputName,
//-                                 value=String.fromCharCode(65 + optIndex),
//-                                 required,
//-                                 onchange='updateAnsweredCount()'
//-                               )
//-                               label.form-check-label(for=inputId, style='cursor: pointer;')
//-                                 | #{String.fromCharCode(65 + optIndex)}. #{option || 'Không có nội dung đáp án'}
//-                         else
//-                           p.text-warning.fw-bold Không có lựa chọn đáp án hợp lệ.
//-                     else if partKey === 'Part 5'
//-                       .question.border.p-4.mb-4.rounded.bg-white.shadow-sm
//-                         h5.mb-3.text-dark Câu #{question.displayNumber}
//-                         p.mb-3.fw-bold.text-muted #{question.questionText || 'Không có nội dung câu hỏi'}

//-                         if question.options && Array.isArray(question.options) && question.options.length === 4
//-                           each option, optIndex in question.options
//-                             .form-check.mb-2
//-                               - const inputId = `${question.questionId}-${optIndex}`
//-                               - const inputName = `answers[${question.questionId}-0]`
//-                               input.form-check-input(
//-                                 type='radio',
//-                                 id=inputId,
//-                                 name=inputName,
//-                                 value=String.fromCharCode(65 + optIndex),
//-                                 required,
//-                                 onchange='updateAnsweredCount()'
//-                               )
//-                               label.form-check-label(for=inputId, style='cursor: pointer;')
//-                                 | #{String.fromCharCode(65 + optIndex)}. #{option || 'Không có nội dung đáp án'}
//-                         else
//-                           p.text-warning.fw-bold Không có lựa chọn đáp án hợp lệ.

//-         // Nút nộp bài
//-         .d-flex.justify-content-end.mt-5
//-           button.btn.btn-success(type='button', onclick='confirmSubmit()')
//-             i.bi.bi-check-circle.me-2
//-             | Nộp bài

//-     // Thêm Bootstrap Icons và Bootstrap JS
//-     link(href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css', rel='stylesheet')
//-     script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js')

//-     // Script quản lý timer, đếm câu trả lời và xác nhận nộp bài
//-     script.
//-       let time = localStorage.getItem('toeicTimer') ? parseInt(localStorage.getItem('toeicTimer')) : 1800;
//-       const timerDisplay = document.getElementById('timer');
//-       let countdown;

//-       function startTimer() {
//-         countdown = setInterval(() => {
//-           const minutes = Math.floor(time / 60);
//-           const seconds = time % 60;
//-           timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
//-           localStorage.setItem('toeicTimer', time);
//-           time--;
//-           if (time < 0) {
//-             clearInterval(countdown);
//-             timerDisplay.textContent = 'Hết giờ!';
//-             localStorage.removeItem('toeicTimer');
//-             document.getElementById('examForm').submit();
//-           }
//-         }, 1000);
//-       }

//-       function updateAnsweredCount() {
//-         const answered = document.querySelectorAll('input[type="radio"]:checked').length;
//-         document.getElementById('answeredCount').textContent = answered;
//-       }

//-       function confirmSubmit() {
//-         const totalQuestions = document.querySelectorAll('.question').length;
//-         const answered = document.querySelectorAll('input[type="radio"]:checked').length;
//-         const unanswered = totalQuestions - answered;
//-         if (unanswered > 0) {
//-           if (confirm(`Bạn còn ${unanswered} câu chưa trả lời. Bạn có chắc muốn nộp bài không?`)) {
//-             clearInterval(countdown);
//-             localStorage.removeItem('toeicTimer');
//-             document.getElementById('examForm').submit();
//-           }
//-         } else {
//-           if (confirm('Bạn đã hoàn thành bài thi. Bạn có chắc muốn nộp bài không?')) {
//-             clearInterval(countdown);
//-             localStorage.removeItem('toeicTimer');
//-             document.getElementById('examForm').submit();
//-           }
//-         }
//-       }

//-       document.addEventListener('DOMContentLoaded', () => {
//-         startTimer();
//-         updateAnsweredCount();
//-       });
extends ../layouts/default

block content
  .container.mt-5
    h1.text-center.mb-5 Đề thi Reading TOEIC
    if error
      .alert.alert-danger.text-center(role='alert')
        i.bi.bi-exclamation-triangle.me-2
        | #{error}
    else if !examPart
      .alert.alert-info.text-center(role='alert')
        i.bi.bi-info-circle.me-2
        | Không có đề thi Reading nào được tìm thấy hoặc đề thi chưa được public.
    else
      .card.mb-5.shadow-sm
        .card-header.bg-primary.text-white.d-flex.justify-content-between.align-items-center
          h2.mb-0 Đề #{examPart._id} - Part #{examPart.part ? examPart.part.join(', ') : 'N/A'}
          span.badge.bg-light.text-dark Độ khó: #{difficultyMap[examPart.difficulty] || 'Chưa xác định'}
        .card-body
          .d-flex.justify-content-between.align-items-center.mb-4
            p.mb-0.fw-bold
              | Thời gian còn lại: 
              span#timer.text-danger.fw-bold.ms-2 #{isSubmitted ? 'Đã nộp bài' : '30:00'}
            p.mb-0.fw-bold
              | Đã trả lời: 
              span#answeredCount.text-primary.fw-bold.ms-2 0
            a.btn.btn-outline-secondary.btn-sm(href='/toeic/reading') Quay lại danh sách đề
          if isSubmitted
            .alert.alert-info.text-center
              p Kết quả: #{score} / #{totalQuestions} (#{percentage.toFixed(2)}%)
      if !questionsByPart['Part 5'] && examPart.part.includes(5)
        .alert.alert-warning.text-center(role='alert')
          i.bi.bi-exclamation-circle.me-2
          | Không có câu hỏi nào cho Part 5.
      if !questionsByPart['Part 6'] && examPart.part.includes(6)
        .alert.alert-warning.text-center(role='alert')
          i.bi.bi-exclamation-circle.me-2
          | Không có câu hỏi nào cho Part 6.
      if !questionsByPart['Part 7'] && examPart.part.includes(7)
        .alert.alert-warning.text-center(role='alert')
          i.bi.bi-exclamation-circle.me-2
          | Không có câu hỏi nào cho Part 7.
      form#examForm(action=`/toeic/reading/${examPart._id}/submit` method='POST' class=isSubmitted ? 'submitted' : '')
        input(type='hidden' name='examPartId' value=examPart._id)
        each partKey in ['Part 5', 'Part 6', 'Part 7']
          if questionsByPart[partKey]
            .card.mt-4.shadow-sm
              .card-header.bg-light.fw-bold.text-dark #{partKey}
              .card-body
                - let currentPassage = null
                each question in questionsByPart[partKey]
                  if question.type === 'passage'
                    - currentPassage = question
                    .mb-4
                      p.mb-2.fw-bold Câu #{question.displayNumber}:
                      pre.bg-light.p-3.rounded.border(style='white-space: pre-wrap; font-size: 1rem;') #{question.passage || 'Không có đoạn văn'}
                      if question.Img
                        img.img-fluid.rounded.mb-3(src=question.Img alt='Passage Image' style='max-height: 300px; max-width: 100%;')
                  else
                    - const result = isSubmitted && results ? results.find(r => r.questionId.toString() === question.questionId.toString() && (r.blankIndex || 0) === (question.blankIndex || 0) && (r.subQuestionIndex || 0) === (question.subQuestionIndex || 0)) : null
                    if (partKey === 'Part 6' || partKey === 'Part 7') && currentPassage && currentPassage.questionId.toString() === question.questionId.toString()
                      .question.border.p-4.mb-4.rounded.bg-white.shadow-sm(class=result ? (result.isCorrect ? 'bg-correct' : 'bg-incorrect') : '')
                        h5.mb-3.text-dark #{question.displayNumber}
                        p.mb-3.fw-bold.text-muted #{question.questionText || 'Không có nội dung câu hỏi'}
                        if question.options && Array.isArray(question.options) && question.options.length === 4
                          each option, optIndex in question.options
                            .form-check.mb-2
                              - const inputId = `${question.questionId}-${question.blankIndex || question.subQuestionIndex || 0}-${optIndex}`
                              - const inputName = `answers[${question.questionId}-${question.blankIndex || question.subQuestionIndex || 0}]`
                              input.form-check-input(
                                type='radio'
                                id=inputId
                                name=inputName
                                value=String.fromCharCode(65 + optIndex)
                                required=!isSubmitted
                                disabled=isSubmitted
                                checked=result && result.userAnswer === String.fromCharCode(65 + optIndex)
                                onchange=!isSubmitted ? 'updateAnsweredCount()' : undefined
                              )
                              label.form-check-label(for=inputId style='cursor: pointer;')
                                | #{String.fromCharCode(65 + optIndex)}. #{option || 'Không có nội dung đáp án'}
                        else
                          p.text-warning.fw-bold Không có lựa chọn đáp án hợp lệ.
                        if isSubmitted && result
                          .result.mt-2
                            p
                              strong Đáp án của bạn: 
                              | #{result.userAnswer}
                            p
                              strong Đáp án đúng: 
                              | #{result.correctAnswer}
                            p
                              strong Kết quả: 
                              | #{result.isCorrect ? 'Đúng' : 'Sai'}
                            if !result.isCorrect && result.explanation
                              p
                                strong Giải thích: 
                                | #{result.explanation}
                    else if partKey === 'Part 5'
                      .question.border.p-4.mb-4.rounded.bg-white.shadow-sm(class=result ? (result.isCorrect ? 'bg-correct' : 'bg-incorrect') : '')
                        h5.mb-3.text-dark Câu #{question.displayNumber}
                        p.mb-3.fw-bold.text-muted #{question.questionText || 'Không có nội dung câu hỏi'}
                        if question.options && Array.isArray(question.options) && question.options.length === 4
                          each option, optIndex in question.options
                            .form-check.mb-2
                              - const inputId = `${question.questionId}-${optIndex}`
                              - const inputName = `answers[${question.questionId}-0]`
                              input.form-check-input(
                                type='radio'
                                id=inputId
                                name=inputName
                                value=String.fromCharCode(65 + optIndex)
                                required=!isSubmitted
                                disabled=isSubmitted
                                checked=result && result.userAnswer === String.fromCharCode(65 + optIndex)
                                onchange=!isSubmitted ? 'updateAnsweredCount()' : undefined
                              )
                              label.form-check-label(for=inputId style='cursor: pointer;')
                                | #{String.fromCharCode(65 + optIndex)}. #{option || 'Không có nội dung đáp án'}
                        else
                          p.text-warning.fw-bold Không có lựa chọn đáp án hợp lệ.
                        if isSubmitted && result
                          .result.mt-2
                            p
                              strong Đáp án của bạn: 
                              | #{result.userAnswer}
                            p
                              strong Đáp án đúng: 
                              | #{result.correctAnswer}
                            p
                              strong Kết quả: 
                              | #{result.isCorrect ? 'Đúng' : 'Sai'}
                            if !result.isCorrect && result.explanation
                              p
                                strong Giải thích: 
                                | #{result.explanation}
        .d-flex.justify-content-end.mt-5
          if !isSubmitted
            button.btn.btn-success(type='button' onclick='confirmSubmit()')
              i.bi.bi-check-circle.me-2
              | Nộp bài
          else
            a.btn.btn-secondary(href='/toeic/reading')
              i.bi.bi-arrow-left-circle.me-2
              | Quay lại danh sách đề thi

  style.
    .bg-correct { background-color: #e0ffe0; }
    .bg-incorrect { background-color: #ffe0e0; }
    .result { font-size: 0.9em; }
    .submitted .form-check-input { cursor: not-allowed; }
    .submitted button[type='submit'] { display: none; }

block scripts
  link(href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css' rel='stylesheet')
  script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js')
  if !isSubmitted
    script.
      let time = localStorage.getItem('toeicTimer') ? parseInt(localStorage.getItem('toeicTimer')) : 1800;
      const timerDisplay = document.getElementById('timer');
      let countdown;
      function startTimer() {
        countdown = setInterval(() => {
          const minutes = Math.floor(time / 60);
          const seconds = time % 60;
          timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
          localStorage.setItem('toeicTimer', time);
          time--;
          if (time < 0) {
            clearInterval(countdown);
            timerDisplay.textContent = 'Hết giờ!';
            localStorage.removeItem('toeicTimer');
            document.getElementById('examForm').submit();
          }
        }, 1000);
      }
      function updateAnsweredCount() {
        const answered = document.querySelectorAll('input[type="radio"]:checked').length;
        document.getElementById('answeredCount').textContent = answered;
      }
      function confirmSubmit() {
        const totalQuestions = document.querySelectorAll('.question').length;
        const answered = document.querySelectorAll('input[type="radio"]:checked').length;
        const unanswered = totalQuestions - answered;
        if (unanswered > 0) {
          if (confirm(`Bạn còn ${unanswered} câu chưa trả lời. Bạn có chắc muốn nộp bài không?`)) {
            clearInterval(countdown);
            localStorage.removeItem('toeicTimer');
            document.getElementById('examForm').submit();
          }
        } else {
          if (confirm('Bạn đã hoàn thành bài thi. Bạn có chắc muốn nộp bài không?')) {
            clearInterval(countdown);
            localStorage.removeItem('toeicTimer');
            document.getElementById('examForm').submit();
          }
        }
      }
      document.addEventListener('DOMContentLoaded', () => {
        startTimer();
        updateAnsweredCount();
      });
  else
    script.
      document.getElementById('examForm').classList.add('submitted');
      document.querySelectorAll('input[type="radio"]').forEach(input => {
        input.disabled = true;
      });